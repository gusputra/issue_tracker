{% extends 'base.html' %}
{% block title %}Recent Issues{% endblock %}
{% block content %}

<div class="min-h-screen bg-gradient-to-br from-emerald-900/50 via-sky-900/40 to-slate-900/60 backdrop-blur-md p-8">

  <!-- HEADER -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-white drop-shadow-lg">Recent Issues</h1>
    <p class="text-white/70 mt-2">View, filter, and manage recent issue reports</p>
  </div>

  <!-- FILTER & SEARCH FORM -->
  <form method="GET" class="mb-8 flex flex-col md:flex-row justify-center gap-4 items-center bg-white/10 backdrop-blur-xl rounded-2xl p-4 shadow-lg border border-white/10">

    <input
      type="text"
      name="search"
      value="{{ search_query }}"
      placeholder="üîç Search issue..."
      class="w-full md:w-1/3 p-3 rounded-xl bg-white/20 placeholder-white/60 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 transition"
    >

    <select
      name="status"
      class="w-full md:w-1/6 p-3 rounded-xl bg-white/20 text-white focus:ring-2 focus:ring-emerald-400 transition"
    >
      <option value="">Status</option>
      <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
      <option value="Closed" {% if status_filter == 'Closed' %}selected{% endif %}>Closed</option>
    </select>

    <select
      name="level"
      class="w-full md:w-1/6 p-3 rounded-xl bg-white/20 text-white focus:ring-2 focus:ring-emerald-400 transition"
    >
      <option value="">Level</option>
      <option value="Low" {% if level_filter == 'Low' %}selected{% endif %}>Low</option>
      <option value="Medium" {% if level_filter == 'Medium' %}selected{% endif %}>Medium</option>
      <option value="High" {% if level_filter == 'High' %}selected{% endif %}>High</option>
    </select>

    <button
      type="submit"
      class="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl shadow-lg transition transform hover:scale-105"
    >
      Apply
    </button>
  </form>

  <!-- ISSUES TABLE -->
  <div class="overflow-x-auto bg-white/10 backdrop-blur-xl border border-white/10 rounded-2xl shadow-xl">
    <table class="min-w-full text-white text-left">
      <thead class="bg-white/20">
        <tr>
          <th class="p-4">Property Name</th>
          <th class="p-4">Description</th>
          <th class="p-4">Status</th>
          <th class="p-4">Level</th>
          <th class="p-4">Handled By</th>
          <th class="p-4">Created At</th>
          <th class="p-4 text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
        <tr class="hover:bg-white/10 transition">
          <td class="p-4 font-semibold">{{ issue.property_name }}</td>
          <td class="p-4">{{ issue.description }}</td>
          <td class="p-4">
            {% if issue.status == 'Closed' %}
              <span class="bg-red-500/40 px-3 py-1 rounded-lg text-sm">{{ issue.status }}</span>
            {% else %}
              <span class="bg-yellow-400/40 px-3 py-1 rounded-lg text-sm">{{ issue.status }}</span>
            {% endif %}
          </td>
          <td class="p-4">
            {% if issue.level == 'High' %}
              <span class="bg-red-500/40 px-3 py-1 rounded-lg text-sm">{{ issue.level }}</span>
            {% elif issue.level == 'Medium' %}
              <span class="bg-yellow-400/40 px-3 py-1 rounded-lg text-sm">{{ issue.level }}</span>
            {% else %}
              <span class="bg-green-400/40 px-3 py-1 rounded-lg text-sm">{{ issue.level }}</span>
            {% endif %}
          </td>
          <td class="p-4">{{ issue.handled_by }}</td>
          <td class="p-4">{{ issue.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td class="p-4 text-center">
            <a href="{{ url_for('edit_issue', id=issue.id) }}" class="px-4 py-2 bg-blue-500/60 hover:bg-blue-600/80 rounded-lg transition text-sm">Edit</a>
            {% if role == 'admin' %}
            <a href="{{ url_for('delete', id=issue.id) }}" onclick="return confirm('Are you sure you want to delete this issue?')" class="px-4 py-2 bg-red-500/60 hover:bg-red-600/80 rounded-lg transition text-sm ml-2">Delete</a>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="p-6 text-center text-white/60">No issues found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  {% if pagination.pages > 1 %}
  <div class="flex justify-center items-center gap-2 mt-6">
    {% if pagination.has_prev %}
    <a href="{{ url_for('recent', page=pagination.prev_num, search=search_query, status=status_filter, level=level_filter) }}"
      class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg border border-white/10 transition">‚Üê Prev</a>
    {% endif %}

    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
      {% if page_num %}
        {% if page_num == pagination.page %}
        <span class="px-4 py-2 bg-emerald-500/70 text-white rounded-lg shadow-md border border-white/10">{{ page_num }}</span>
        {% else %}
        <a href="{{ url_for('recent', page=page_num, search=search_query, status=status_filter, level=level_filter) }}"
          class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg border border-white/10 transition">{{ page_num }}</a>
        {% endif %}
      {% else %}
        <span class="text-white/50">‚Ä¶</span>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
    <a href="{{ url_for('recent', page=pagination.next_num, search=search_query, status=status_filter, level=level_filter) }}"
      class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg border border-white/10 transition">Next ‚Üí</a>
    {% endif %}
  </div>
  {% endif %}

</div>

{% endblock %}
